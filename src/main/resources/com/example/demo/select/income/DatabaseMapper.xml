<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.select.income.DatabaseMapper">
	<select id="selectGroup" resultType="com.example.demo.select.GroupResultForm">
		SELECT
			<if test="checkGroupYear">
				TIME_FORMAT(income_date,"%Y")	AS "groupdate",
			</if>
			<if test="checkGroupMonth">
				TIME_FORMAT(income_date,"m%")	AS "groupdate",
			</if>
			SUM(income_money)					AS "money"
		FROM(
			(SELECT
				earnings.earnings_date	AS "income_date",
				earnings.money			AS "income_money"
			FROM earnings
				INNER JOIN suppliers ON earnings.suppliers_id = suppliers.id AND earnings.company_id = suppliers.company_id
			<where>
				company_id = #{companyAccountId}
				<if test="earningsName != null">
					AND suppliers.name LIKE #{earningsName}
				</if>
				<if test="earningsId != null">
					AND earnings.suppliers_id = #{earningsId}
				</if>
				<if test="checkDisplayed">
					AND suppliers.is_displayed = TRUE
				</if>
			</where>)
			UNION ALL 
			(SELECT
				expenses.expenses_date,
				(0 - expenses.money)
			FROM expenses
				INNER JOIN expenses_item ON expenses.expenses_item_id = expenses_item.id AND expenses.company_id = expenses_item.company_id
			<where>
				company_id = #{companyAccountId}
				<if test="checkDisplayed">
					AND suppliers.is_displayed = TRUE
				</if>
			</where>
			)
		)
		<where>
			<if test="earningsDateStart != null">
				income_date >= #{earningsDateStart}
			</if>
			<if test="earningsDateFinish != null">
				AND #{earningsDateFinish} >= income_date
			</if>
		</where>
		GROUP BY groupdate
	</select>
</mapper>